<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />

<meta name="viewport" content="width=device-width, initial-scale=1" />


<meta name="date" content="2024-12-20" />

<title>fbwR Shiny: How to use this app</title>

<script>// Pandoc 2.9 adds attributes on both header and div. We remove the former (to
// be compatible with the behavior of Pandoc < 2.8).
document.addEventListener('DOMContentLoaded', function(e) {
  var hs = document.querySelectorAll("div.section[class*='level'] > :first-child");
  var i, h, a;
  for (i = 0; i < hs.length; i++) {
    h = hs[i];
    if (!/^h[1-6]$/i.test(h.tagName)) continue;  // it should be a header h1-h6
    a = h.attributes;
    while (a.length > 0) h.removeAttribute(a[0].name);
  }
});
</script>

<style type="text/css">
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
span.underline{text-decoration: underline;}
div.column{display: inline-block; vertical-align: top; width: 50%;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
</style>



<style type="text/css">
code {
white-space: pre;
}
.sourceCode {
overflow: visible;
}
</style>
<style type="text/css" data-origin="pandoc">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
{ counter-reset: source-line 0; }
pre.numberSource code > span
{ position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
{ content: counter(source-line);
position: relative; left: -1em; text-align: right; vertical-align: baseline;
border: none; display: inline-block;
-webkit-touch-callout: none; -webkit-user-select: none;
-khtml-user-select: none; -moz-user-select: none;
-ms-user-select: none; user-select: none;
padding: 0 4px; width: 4em;
color: #aaaaaa;
}
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa; padding-left: 4px; }
div.sourceCode
{ }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } 
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.at { color: #7d9029; } 
code span.bn { color: #40a070; } 
code span.bu { color: #008000; } 
code span.cf { color: #007020; font-weight: bold; } 
code span.ch { color: #4070a0; } 
code span.cn { color: #880000; } 
code span.co { color: #60a0b0; font-style: italic; } 
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.do { color: #ba2121; font-style: italic; } 
code span.dt { color: #902000; } 
code span.dv { color: #40a070; } 
code span.er { color: #ff0000; font-weight: bold; } 
code span.ex { } 
code span.fl { color: #40a070; } 
code span.fu { color: #06287e; } 
code span.im { color: #008000; font-weight: bold; } 
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.kw { color: #007020; font-weight: bold; } 
code span.op { color: #666666; } 
code span.ot { color: #007020; } 
code span.pp { color: #bc7a00; } 
code span.sc { color: #4070a0; } 
code span.ss { color: #bb6688; } 
code span.st { color: #4070a0; } 
code span.va { color: #19177c; } 
code span.vs { color: #4070a0; } 
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } 
</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    var j = 0;
    while (j < rules.length) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") {
        j++;
        continue;
      }
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') {
        j++;
        continue;
      }
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>




<style type="text/css">body {
background-color: #fff;
margin: 1em auto;
max-width: 700px;
overflow: visible;
padding-left: 2em;
padding-right: 2em;
font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
font-size: 14px;
line-height: 1.35;
}
#TOC {
clear: both;
margin: 0 0 10px 10px;
padding: 4px;
width: 400px;
border: 1px solid #CCCCCC;
border-radius: 5px;
background-color: #f6f6f6;
font-size: 13px;
line-height: 1.3;
}
#TOC .toctitle {
font-weight: bold;
font-size: 15px;
margin-left: 5px;
}
#TOC ul {
padding-left: 40px;
margin-left: -1.5em;
margin-top: 5px;
margin-bottom: 5px;
}
#TOC ul ul {
margin-left: -2em;
}
#TOC li {
line-height: 16px;
}
table {
margin: 1em auto;
border-width: 1px;
border-color: #DDDDDD;
border-style: outset;
border-collapse: collapse;
}
table th {
border-width: 2px;
padding: 5px;
border-style: inset;
}
table td {
border-width: 1px;
border-style: inset;
line-height: 18px;
padding: 5px 5px;
}
table, table th, table td {
border-left-style: none;
border-right-style: none;
}
table thead, table tr.even {
background-color: #f7f7f7;
}
p {
margin: 0.5em 0;
}
blockquote {
background-color: #f6f6f6;
padding: 0.25em 0.75em;
}
hr {
border-style: solid;
border: none;
border-top: 1px solid #777;
margin: 28px 0;
}
dl {
margin-left: 0;
}
dl dd {
margin-bottom: 13px;
margin-left: 13px;
}
dl dt {
font-weight: bold;
}
ul {
margin-top: 0;
}
ul li {
list-style: circle outside;
}
ul ul {
margin-bottom: 0;
}
pre, code {
background-color: #f7f7f7;
border-radius: 3px;
color: #333;
white-space: pre-wrap; 
}
pre {
border-radius: 3px;
margin: 5px 0px 10px 0px;
padding: 10px;
}
pre:not([class]) {
background-color: #f7f7f7;
}
code {
font-family: Consolas, Monaco, 'Courier New', monospace;
font-size: 85%;
}
p > code, li > code {
padding: 2px 0px;
}
div.figure {
text-align: center;
}
img {
background-color: #FFFFFF;
padding: 2px;
border: 1px solid #DDDDDD;
border-radius: 3px;
border: 1px solid #CCCCCC;
margin: 0 5px;
}
h1 {
margin-top: 0;
font-size: 35px;
line-height: 40px;
}
h2 {
border-bottom: 4px solid #f7f7f7;
padding-top: 10px;
padding-bottom: 2px;
font-size: 145%;
}
h3 {
border-bottom: 2px solid #f7f7f7;
padding-top: 10px;
font-size: 120%;
}
h4 {
border-bottom: 1px solid #f7f7f7;
margin-left: 8px;
font-size: 105%;
}
h5, h6 {
border-bottom: 1px solid #ccc;
font-size: 105%;
}
a {
color: #0033dd;
text-decoration: none;
}
a:hover {
color: #6666ff; }
a:visited {
color: #800080; }
a:visited:hover {
color: #BB00BB; }
a[href^="http:"] {
text-decoration: underline; }
a[href^="https:"] {
text-decoration: underline; }

code > span.kw { color: #555; font-weight: bold; } 
code > span.dt { color: #902000; } 
code > span.dv { color: #40a070; } 
code > span.bn { color: #d14; } 
code > span.fl { color: #d14; } 
code > span.ch { color: #d14; } 
code > span.st { color: #d14; } 
code > span.co { color: #888888; font-style: italic; } 
code > span.ot { color: #007020; } 
code > span.al { color: #ff0000; font-weight: bold; } 
code > span.fu { color: #900; font-weight: bold; } 
code > span.er { color: #a61717; background-color: #e3d2d2; } 
</style>




</head>

<body>




<h1 class="title toc-ignore">fbwR Quickstart Guide</h1>
<h4 class="date">2024-12-20</h4>



<p><code>fbwR</code> is an R-based version of the <strong>Fish Benefits
Workbook</strong>, a modelling approach to integrating hydrology and
fish behavior to predict the passage efficiency and survival of fish as
they pass downstream of dams. It considers the movement of fish as they
pass from the forebay of a dam to its tailrace, accounting for which
routes fish can take through the dam at time of passage, and the
relative survival of passage through those routes.</p>
<p>To simulate downstream passage of fish, especially fish that migrate
with the flow of water during seaward migration, it is useful to build a
model that incorporates two things:</p>
<ol style="list-style-type: decimal">
<li><strong>Hydrology</strong>: the position and velocity of water
passing through a dam.</li>
<li><strong>Responses to hydrology</strong>: how hydrological influences
will impact where and how well fish can approach, enter, and
successfully pass the dam.</li>
</ol>
<p><code>fbwR</code> combines these in a way that allows for modellers
and decision makers to assess changes to dam operations (including, for
example, the distribution of flow through a dam, timing of flow
operations, and reservoir elevation) and changes to dam structures
(including the building of fish passage structures).</p>
<div id="data-requirements" class="section level2">
<h2>Data requirements</h2>
<p>fbwR requires two types of inputs (as indicated above): hydrological conditions at the dams, and parameters describing how fish respond to hydrology.</p>
<div id="step1-ressim" class="section level2"></div>
<h2>Step 1: Upload results of a ResSim hydrological simulation model</h2>
<p>The first step is to upload HEC-ResSim files (in the form of .xlsx or .xlsm) to the app. Looking at the top panel of the application, click on the "Hydrology inputs" tab.</p>
<p>There, you will see three panels: a light blue panel including helptext, and two dark blue panels where you specify how to read in the ResSim file. Click the light blue helptext box on this tab for full details on the required data format for ResSim simulation model results and how to upload the required data.</p> 
<p>After uploading the files, the app will ask you to verify which sheets in the workbook contain the required types of hydrological information (e.g., which sheet includes pool elevation, which one includes total outflow, etc.). Clicking on the "Next (compiles ResSim)" button takes you to a preview page, where you can see the uploaded and compiled ResSim hydrological variables for each day in the period of record.</p>
</div>
<div id="step2-biological" class="section level2"></div>
<h2>Step 2: Upload fish passage and dam operation parameters</h2>
<p>After uploading hydrological information, you can then upload details of dam operation and fish responses to hydrology.</p>
<p>Click on the tab labelled "Fish passage parameters" to see the four steps of this process: </p>
<ol style="list-style-type: decimal">
  <li><strong>Upload parameters from a template</strong>: On this tab, you can upload a pre-filled parameter template and download your input parameters as an Excel file that matches the template format. You can also download a blank template to save to your computer and fill in manually outside of the Shiny app.<br><br><i>If you do not have a parameter template, or want to adjust the parameters you entered, go on to fill in the parameters in three steps:</i></li>
  <li><strong>Step 1. Dam passage/outlet settings</strong>: Here, enter parameters about how the dam is operated. This includes which dam outlets to simulate, whether a fish passage structure should be simulated, the operational limits of those outlets (e.g., pool elevations where they can pass flow), and outlet attractiveness. For full details, see the </li>
  <li><strong>Step 2. Monthly run timing and dam passage efficiency</strong>: </li>
  <li><strong>Step 3. Passage survival</strong>:</li>
  </ol>  
<div id="getting-started-with-the-software" class="section level2">
<h2>Getting started with the software</h2>
<p>To use fbwR, you first have to install the package. Currently, the
best way to install the R package is to download and install from the
GitHub repository using the devtools library.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="co"># If you don&#39;t already have devtools installed: </span></span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a><span class="fu">install.packages</span>(<span class="st">&quot;devtools&quot;</span>)</span>
<span id="cb1-3"><a href="#cb1-3" tabindex="-1"></a>devtools<span class="sc">::</span><span class="fu">install_github</span>(<span class="at">repo =</span> <span class="st">&quot;mairindeith/fbwR&quot;</span>)</span></code></pre></div>

<p>(If you see the following message, this means that you previously
installed the package and it is still in the most up-to-date
version)</p>
<pre><code>Skipping install of &#39;fbwR&#39; from a github remote, the SHA1 has not changed since last install.</code></pre>
<p>Then, load the package into your session:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a><span class="fu">library</span>(fbwR)</span></code></pre></div>

</div>
<div id="running-the-fbwr-model" class="section level2">
<h2>Running the fbwR model</h2>
<div id="launching-the-shiny-app" class="section level3">
<h3>Launching the Shiny app</h3>
<p>The simplest way to interact with the fbwR model is using the Shiny
app–a graphical interface where you can input parameters, visualize
relationships between model components, run the model, and save its
outputs.</p>
<p>You can run the Shiny app locally on your computer using the
<code>runApp()</code> function of fbwR (with no arguments):</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a>fbwR<span class="sc">::</span><span class="fu">runApp</span>()</span></code></pre></div>

<p>When you do, your R console should read something like this:</p>
<pre><code>&gt; fbwR::runApp()

Listening on http://127.0.0.1:5651</code></pre>
<p>If you click on the hyperlink, it will open an interactive Shiny
application where you can input required data</p>
</div>
<div id="required-input-parameters" class="section level3">
<h3>Required input parameters</h3>
<p>fbwR provides three functions which load the parameters necessary to
run the fbwR model:</p>
<ol style="list-style-type: decimal">
<li><code>loadResSim()</code>: This loads hydrological parameters (pool
elevation, total outflow, and flow through each permanent dam outlet)
from a HEC-ResSim simulation result</li>
<li><code>loadFromTemplate()</code>: This loads biological and
operational parameters from an FBW parameter template. You can download
the template using</li>
<li><code>loadFromWorkbook()</code>: FBW was previously only available
as an Excel workbook; if you have a pre-filled workbook on hand, you can
load all required parameters–hydrological, biological, and
operational–from the workbook using this function.</li>
</ol>
</div>
<div id="running-an-fbwr-model-run-in-a-single-step" class="section level3">
<h3>Running an fbwR model run in a single step</h3>
<p>If you already have a filled-in Excel workbook, fbwR template, and a
ResSim results file, you can run the fbwR package in a single
function:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a>fbwR<span class="sc">::</span><span class="fu">runFBW</span>()</span></code></pre></div>

<p><code>runFBW</code> is designed to be able to read in hydrological
and fish biology parameters from different sources, depending on the
datasets available to the user. There are two ways to provide inputs to
<code>runFBW()</code>:</p>
<ol style="list-style-type: decimal">
<li><strong>Using file paths to a template and a ResSim result</strong>:
If you have a ResSim file and a parameter template ready to load into
the model, you can use
<code>runFBW(template_file = &quot;PATH_TO_TEMPLATE&quot;, ressim_file = &quot;PATH_TO_RESSIM&quot;, ...)</code>.
This will upload the data from those file paths and run the FBW
model.</li>
<li><strong>Using previously uploaded data lists</strong>: If you have
already loaded ResSim and biological parameters into your R session
using the <code>load...</code> functions above, you can use these
objects to run the model via
<code>runFBW(param_list = NAME_OF_PARAMETER_OBJECT, ressim = NAME_OF_RESSIM_OBJECT)</code>.For
example:</li>
</ol>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a>biol_params <span class="ot">&lt;-</span> fbwR<span class="sc">::</span><span class="fu">loadFromTemplate</span>(<span class="at">file =</span> <span class="st">&quot;PATH_TO_TEMPLATE&quot;</span>)</span>
<span id="cb7-2"><a href="#cb7-2" tabindex="-1"></a>ressim_results <span class="ot">&lt;-</span> fbwR<span class="sc">::</span><span class="fu">loadResSim</span>(<span class="at">file =</span> <span class="st">&quot;PATH_TO_RESSIM&quot;</span>)</span></code></pre></div>

</div>
<div id="running-the-fbwr-steps-one-at-a-time" class="section level3">
<h3>Running the fbwR steps one-at-a-time</h3>
<p>You can also run the fbwR model step-by-step (if you take a look
under the hood of the <code>runFBW</code> function, you’ll notice that
all of the below functions are executed there). Here is a brief
description of the steps:</p>
<ol style="list-style-type: decimal">
<li><code>distributeFishDaily</code>: Transform monthly run timing data
(and optionally outflow rates) into daily estimates of the proportion of
the cohort that is in the dam forebay for each day of the year.</li>
<li><code>fetchDPE</code>: Using a dam passage efficiency table and pool
elevation in each day, calculate daily DPE experienced by fish in the
forebay.</li>
<li><code>distributeFish_outlets</code>: Of those fish that enter the
dam (i.e., the fish present in the forebay multiplied by the DPE in that
day), what proportion enter each of the dam outlets? This is calculated
in response to the distribution of flow and route attractiveness.</li>
<li><code>distributeFlow_Survival_gates</code>: Calculate survival
through each outlet. If survival through some outlet is to be simulated
as a function of flow, FBW first calculates flow through that outlet
(and, if there are multiple gates splitting the flow, how much flow
passes through each gate). Then, flow rates are used to calculate
survival rate.</li>
<li>Optionally: <code>summarizeFBW</code>: Roll up passage statistics
(dam passage efficiency and survival; DPE and DPS, respectively) from
daily timesteps into summary statistics of average annual survival and
passage efficiency. This step can be skipped if daily dam passage
simulations are sufficient.</li>
</ol>
<p>For more details on these, please take a look at the documentation
for each function. Every function in the fbwR package has documentation
that describes the function and purpose of each step, as well as what
arguments the function requires. You can find out more about any
particular step of the model by typing <code>?FUNCTION_NAME</code>
(where <code>FUNCTION_NAME</code> is whatever function you want to learn
more about. For example, to find out more about the <code>runFBW</code>
function, type <code>?fbwR::runFBW</code>).</p>
</div>
</div>



<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
